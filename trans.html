<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech to Translation - Chrome Built-in</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, button {
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .model-download-area {
            margin: 10px 0;
            display: none;
        }

        .download-status-area {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .model-queue-status {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 14px;
            margin-left: 10px;
        }

        .display-area {
            background: #2c2c2c;
            padding: 15px;
            border-radius: 8px;
        }

        .text-line {
            margin-bottom: 2px;
            min-height: 32px;
            padding: 8px 12px;
            background: #2c2c2c;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
        }

        .text-line.scrolling .text-content {
            display: inline-block;
            animation: marquee 15s linear infinite;
        }

        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .interim { color: #ff69b4; font-size: 18px; line-height: 1.1; }
        .final { color: #ffffff; font-size: 18px; font-weight: 500; line-height: 1.1; }
        .translation { color: #87ceeb; font-size: 18px; line-height: 1.1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <select id="recog">
                <option value="ja-JP">æ—¥æœ¬èª</option>
                <option value="en-US">è‹±èª</option>
                <option value="zh-CN">ä¸­å›½èª</option>
            </select>
            <select id="trans">
                <option value="none">ç¿»è¨³ãªã—</option>
                <option value="en">è‹±èª</option>
                <option value="zh">ä¸­å›½èª</option>
                <option value="es">ã‚¹ãƒšã‚¤ãƒ³èª</option>
            </select>
            <select id="presetSelect">
                <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                <option value="ja-en">æ—¥æœ¬èªâ†’è‹±èª</option>
                <option value="en-zh">è‹±èªâ†’ä¸­å›½èª</option>
            </select>
        </div>
        <div class="model-download-area" id="modelDownloadArea">
            <button id="preloadModelBtn" disabled>ğŸ“¥ ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <span id="modelStatusText"></span>
            <span id="modelQueueStatus" class="model-queue-status"></span>
        </div>
        <div class="download-status-area" id="downloadStatusArea">
            <span id="downloadStatusText"></span>
        </div>
        <div class="display-area">
            <div class="text-line interim" id="interim">
                <span class="text-content"></span>
            </div>
            <div class="text-line final" id="final">
                <span class="text-content"></span>
            </div>
            <div class="text-line translation" id="translation">
                <span class="text-content"></span>
            </div>
        </div>
    </div>

    <script>
        let recognition = null;
        let translator = null;
        let isRecognizing = false;
        let interimClearTimer = null;
        let finalClearTimer = null;
        let translationClearTimer = null;
        let currentTranslationPair = null;
        let pendingModels = [];

        const interimEl = document.getElementById('interim');
        const finalEl = document.getElementById('final');
        const translationEl = document.getElementById('translation');
        const recogSelect = document.getElementById('recog');
        const transSelect = document.getElementById('trans');
        const presetSelect = document.getElementById('presetSelect');

        function getLanguageDisplayName(langCode) {
            const langMap = {
                'ja-JP': 'æ—¥æœ¬èª', 'en-US': 'è‹±èª', 'zh-CN': 'ä¸­å›½èª',
                'en': 'è‹±èª', 'zh': 'ä¸­å›½èª', 'es': 'ã‚¹ãƒšã‚¤ãƒ³èª'
            };
            return langMap[langCode] || langCode;
        }

        async function initTranslator(sourceLang, targetLang) {
            console.log('[v2] Checking Translator API availability...');
            console.log('[v2] Translator exists:', 'Translator' in self);

            if (!('Translator' in self)) {
                console.error('[v2] Translator APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return null;
            }

            try {
                const sourceLanguage = sourceLang.split('-')[0];
                const translatorInstance = await Translator.create({
                    sourceLanguage: sourceLanguage,
                    targetLanguage: targetLang,
                    monitor: (m) => {
                        m.addEventListener('downloadprogress', (e) => {
                            const progress = (e.loaded / e.total) * 100;
                            console.log(`[v2] ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€²æ—: ${progress.toFixed(2)}%`);
                            const statusArea = document.getElementById('downloadStatusArea');
                            const statusText = document.getElementById('downloadStatusText');
                            if (statusArea && statusText) {
                                statusText.innerHTML = `ğŸ”„ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­... ${progress.toFixed(0)}%`;
                                statusArea.style.display = 'block';
                                statusArea.style.background = `linear-gradient(90deg, #4CAF50 ${progress}%, #ff6b6b ${progress}%)`;
                            }
                        });
                    }
                });
                console.log('[v2] TranslatoråˆæœŸåŒ–æˆåŠŸ');
                return translatorInstance;
            } catch (error) {
                console.error('[v2] ç¿»è¨³æ©Ÿèƒ½ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                return null;
            }
        }

        async function translateText(text) {
            if (!text || !translator) return '';
            try {
                const result = await translator.translate(text);
                console.log('[v2] ç¿»è¨³æˆåŠŸ:', text, '->', result);
                return result;
            } catch (error) {
                console.error('[v2] ç¿»è¨³ã‚¨ãƒ©ãƒ¼:', error);
                return '';
            }
        }

        function checkOverflow(element) {
            const textContent = element.querySelector('.text-content');
            if (textContent.scrollWidth > element.clientWidth) {
                element.classList.add('scrolling');
            } else {
                element.classList.remove('scrolling');
            }
        }

        function updateQueueStatus() {
            const queueStatus = document.getElementById('modelQueueStatus');
            if (queueStatus) {
                if (pendingModels.length > 0) {
                    queueStatus.style.display = 'inline-block';
                    queueStatus.textContent = `ğŸ“¦ æ®‹ã‚Š${pendingModels.length}å€‹`;
                    queueStatus.style.background = pendingModels.length === 1 ? 'rgba(76, 175, 80, 0.1)' :
                        pendingModels.length <= 3 ? 'rgba(255, 193, 7, 0.1)' : 'rgba(244, 67, 54, 0.1)';
                    queueStatus.style.color = pendingModels.length === 1 ? '#4CAF50' :
                        pendingModels.length <= 3 ? '#f57c00' : '#d32f2f';
                } else {
                    queueStatus.style.display = 'none';
                }
            }
        }

        async function checkTranslationModel(event = null) {
            if (!('Translator' in self)) {
                console.error('[v2] Translator APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã®æ©Ÿèƒ½ã¯Chromeã§ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚');
                const modelArea = document.getElementById('modelDownloadArea');
                const modelStatus = document.getElementById('modelStatusText');
                const transSelectEl = document.getElementById('trans');
                if (modelArea) modelArea.style.display = 'none';
                if (modelStatus) modelStatus.textContent = '';
                if (transSelectEl) {
                    transSelectEl.disabled = true;
                    transSelectEl.value = 'none';
                    transSelectEl.title = 'ç¿»è¨³æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“';
                }
                currentTranslationPair = null;
                pendingModels = [];
                updateQueueStatus();
                return;
            }

            const sourceLang = recogSelect.value;
            const targetLang = transSelect.value;
            const modelArea = document.getElementById('modelDownloadArea');
            const modelBtn = document.getElementById('preloadModelBtn');
            const modelStatus = document.getElementById('modelStatusText');

            if (targetLang === 'none' || sourceLang.split('-')[0] === targetLang) {
                currentTranslationPair = null;
                if (modelArea) modelArea.style.display = 'none';
                return;
            }

            try {
                const normalizedSource = sourceLang.split('-')[0];
                const normalizedTarget = targetLang;
                const targetLangName = getLanguageDisplayName(targetLang);

                const availability = await Translator.availability({
                    sourceLanguage: normalizedSource,
                    targetLanguage: normalizedTarget
                });

                console.log(`[v2] ç¿»è¨³ãƒ¢ãƒ‡ãƒ«çŠ¶æ…‹: ${sourceLang} â†’ ${targetLang} = ${availability}`);

                if (availability === 'downloadable') {
                    const isDirectUserGesture = event && event.type === 'change';
                    if (isDirectUserGesture) {
                        console.log(`[v2] è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${targetLangName}`);
                        translator = await initTranslator(sourceLang, targetLang);
                    } else {
                        const exists = pendingModels.some(m =>
                            m.sourceLang === normalizedSource && m.targetLang === normalizedTarget);
                        if (!exists) {
                            pendingModels.push({
                                sourceLang: normalizedSource,
                                targetLang: normalizedTarget,
                                langName: targetLangName
                            });
                            updateQueueStatus();
                        }
                        if (pendingModels.length > 0 && modelArea && modelBtn) {
                            const firstModel = pendingModels[0];
                            modelArea.style.display = 'block';
                            modelBtn.style.display = 'inline-block';
                            modelBtn.disabled = false;
                            modelBtn.style.background = '#ff6b6b';
                            modelBtn.innerHTML = `ğŸ“¥ ${firstModel.langName}ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`;
                            modelStatus.textContent = 'éŸ³å£°èªè­˜è¨€èªå¤‰æ›´å¾Œã¯æ‰‹å‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™';
                            modelStatus.style.color = '#333';
                            currentTranslationPair = {
                                source: sourceLang,
                                target: targetLang,
                                normalizedSource: normalizedSource,
                                normalizedTarget: normalizedTarget
                            };
                        }
                    }
                } else if (availability === 'available') {
                    console.log(`[v2] ç¿»è¨³ãƒ¢ãƒ‡ãƒ«ã¯æ—¢ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿: ${targetLangName}`);
                    if (pendingModels.length === 0 && modelArea) {
                        modelArea.style.display = 'none';
                    }
                    translator = await initTranslator(sourceLang, targetLang);
                } else {
                    console.log(`[v2] ç¿»è¨³ãƒ¢ãƒ‡ãƒ«ã¯åˆ©ç”¨ä¸å¯: ${targetLangName} (${availability})`);
                    if (pendingModels.length === 0 && modelArea) {
                        modelArea.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('[v2] ç¿»è¨³å¯èƒ½æ€§ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                if (modelArea && modelStatus) {
                    modelArea.style.display = 'block';
                    modelStatus.textContent = 'âŒ ç¿»è¨³ãƒ¢ãƒ‡ãƒ«ã®ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
                    modelStatus.style.color = '#f44336';
                }
            }
        }

        async function preloadTranslationModel() {
            let modelToDownload = pendingModels.length > 0 ? pendingModels[0] : currentTranslationPair;
            if (!modelToDownload) return;

            const modelBtn = document.getElementById('preloadModelBtn');
            const modelStatus = document.getElementById('modelStatusText');
            const targetLangName = modelToDownload.langName || getLanguageDisplayName(modelToDownload.target);

            modelBtn.disabled = true;
            modelBtn.innerHTML = `ğŸ“¥ ${targetLangName}ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™ä¸­...`;
            modelStatus.textContent = '';

            try {
                translator = await initTranslator(modelToDownload.source || modelToDownload.sourceLang, modelToDownload.target || modelToDownload.targetLang);
                if (translator) {
                    if (pendingModels.length > 0) {
                        pendingModels.shift();
                        updateQueueStatus();
                    }
                    if (pendingModels.length > 0) {
                        const nextModel = pendingModels[0];
                        modelBtn.disabled = false;
                        modelBtn.style.background = '#ff6b6b';
                        modelBtn.innerHTML = `ğŸ“¥ ${nextModel.langName}ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`;
                        modelStatus.textContent = `âœ… ${targetLangName}å®Œäº†ï¼`;
                        modelStatus.style.color = '#4CAF50';
                        currentTranslationPair = {
                            normalizedSource: nextModel.sourceLang,
                            normalizedTarget: nextModel.targetLang,
                            targetLangName: nextModel.langName
                        };
                    } else {
                        modelBtn.style.display = 'none';
                        modelStatus.textContent = 'âœ… å…¨ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼';
                        modelStatus.style.color = '#4CAF50';
                        setTimeout(() => {
                            document.getElementById('modelDownloadArea').style.display = 'none';
                        }, 3000);
                        currentTranslationPair = null;
                    }
                } else {
                    throw new Error('ç¿»è¨³ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ã«å¤±æ•—');
                }
            } catch (error) {
                console.error('[v2] äº‹å‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                modelBtn.disabled = false;
                modelBtn.style.background = '#ff6b6b';
                modelBtn.innerHTML = `ğŸ“¥ ${targetLangName}ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`;
                modelStatus.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message;
                modelStatus.style.color = '#f44336';
            }
        }

        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                console.error('[v2] éŸ³å£°èªè­˜ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return null;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = recogSelect.value;
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isRecognizing = true;
                console.log('[v2] éŸ³å£°èªè­˜é–‹å§‹æˆåŠŸ');
            };

            recognition.onend = () => {
                console.log('[v2] éŸ³å£°èªè­˜çµ‚äº†');
                isRecognizing = false;
                if (recognition && !isRecognizing) {
                    setTimeout(() => {
                        if (recognition && !isRecognizing) {
                            try {
                                recognition.start();
                                console.log('[v2] éŸ³å£°èªè­˜å†èµ·å‹•');
                            } catch (error) {
                                console.error('[v2] éŸ³å£°èªè­˜å†èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
                            }
                        }
                    }, 1500);
                }
            };

            recognition.onerror = (event) => {
                console.error('[v2] éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
                if (event.error === 'not-allowed') {
                    alert('ãƒã‚¤ã‚¯ã®è¨±å¯ãŒå¿…è¦ã§ã™');
                } else if (event.error !== 'no-speech') {
                    isRecognizing = false;
                    setTimeout(() => {
                        if (recognition && !isRecognizing) {
                            try {
                                recognition.start();
                                console.log('[v2] éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼å¾Œã®å†èµ·å‹•');
                            } catch (error) {
                                console.error('[v2] éŸ³å£°èªè­˜å†èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
                            }
                        }
                    }, 1500);
                }
            };

            recognition.onresult = async (event) => {
                console.log('[v2] éŸ³å£°èªè­˜çµæœå—ä¿¡');
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (interimTranscript) {
                    console.log('[v2] æš«å®šãƒ†ã‚­ã‚¹ãƒˆ:', interimTranscript);
                    if (interimClearTimer) clearTimeout(interimClearTimer);
                    const interimContent = interimEl.querySelector('.text-content');
                    interimContent.textContent = interimTranscript;
                    checkOverflow(interimEl);
                }

                if (finalTranscript) {
                    console.log('[v2] ç¢ºå®šãƒ†ã‚­ã‚¹ãƒˆ:', finalTranscript);
                    if (interimClearTimer) clearTimeout(interimClearTimer);
                    interimClearTimer = setTimeout(() => {
                        interimEl.querySelector('.text-content').textContent = '';
                        interimEl.classList.remove('scrolling');
                    }, 1000);

                    const finalContent = finalEl.querySelector('.text-content');
                    const currentText = finalContent.textContent;
                    const newText = currentText + finalTranscript;
                    finalContent.textContent = newText;
                    checkOverflow(finalEl);

                    if (finalClearTimer) clearTimeout(finalClearTimer);
                    finalClearTimer = setTimeout(() => {
                        finalEl.querySelector('.text-content').textContent = '';
                        finalEl.classList.remove('scrolling');
                    }, 5000);

                    if (transSelect.value !== 'none') {
                        const translated = await translateText(newText);
                        if (translated) {
                            const translationContent = translationEl.querySelector('.text-content');
                            translationContent.textContent = translated;
                            checkOverflow(translationEl);

                            if (translationClearTimer) clearTimeout(translationClearTimer);
                            translationClearTimer = setTimeout(() => {
                                translationEl.querySelector('.text-content').textContent = '';
                                translationEl.classList.remove('scrolling');
                            }, 5000);
                        }
                    }
                }
            };

            return recognition;
        }

        window.addEventListener('load', async () => {
            console.log('[v2] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†ã€åˆæœŸåŒ–é–‹å§‹');

            // ãƒ—ãƒªã‚»ãƒƒãƒˆåˆæœŸåŒ–
            setTimeout(() => {
                const savedPreset = localStorage.getItem('selectedPreset');
                if (savedPreset && presetSelect) {
                    presetSelect.value = savedPreset;
                    const event = new Event('change');
                    presetSelect.dispatchEvent(event);
                } else {
                    presetSelect.value = 'default';
                    const event = new Event('change');
                    presetSelect.dispatchEvent(event);
                }
            }, 500);

            // Translator APIãƒã‚§ãƒƒã‚¯ã¨UIèª¿æ•´
            checkTranslationModel();

            // éŸ³å£°èªè­˜åˆæœŸåŒ–
            recognition = initSpeechRecognition();
            if (!recognition) {
                console.error('[v2] éŸ³å£°èªè­˜åˆæœŸåŒ–å¤±æ•—');
                return;
            }

            try {
                recognition.start();
                console.log('[v2] éŸ³å£°èªè­˜é–‹å§‹æˆåŠŸ');
            } catch (error) {
                console.error('[v2] éŸ³å£°èªè­˜é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
            }

            // ç¿»è¨³ãƒ¢ãƒ‡ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆAPIåˆ©ç”¨å¯èƒ½ã®å ´åˆã®ã¿ï¼‰
            setTimeout(() => {
                checkTranslationModel();
            }, 2000);
        });

        recogSelect.addEventListener('change', (event) => {
            if (recognition) {
                recognition.lang = recogSelect.value;
                if (isRecognizing) {
                    recognition.stop();
                    console.log('[v2] éŸ³å£°èªè­˜åœæ­¢ï¼ˆè¨€èªå¤‰æ›´ï¼‰');
                    setTimeout(() => {
                        if (recognition && !isRecognizing) {
                            try {
                                recognition.start();
                                console.log('[v2] éŸ³å£°èªè­˜å†èµ·å‹•ï¼ˆè¨€èªå¤‰æ›´ï¼‰');
                            } catch (error) {
                                console.error('[v2] éŸ³å£°èªè­˜å†èµ·å‹•ã‚¨ãƒ©ãƒ¼ï¼ˆè¨€èªå¤‰æ›´ï¼‰:', error);
                            }
                        }
                    }, 1500);
                }
            }
            checkTranslationModel(event);
        });

        transSelect.addEventListener('change', (event) => {
            checkTranslationModel(event);
            localStorage.setItem('selectedPreset', presetSelect.value);
        });

        presetSelect.addEventListener('change', (event) => {
            const preset = presetSelect.value;
            if (preset === 'default') {
                recogSelect.value = 'ja-JP';
                transSelect.value = 'none';
            } else if (preset === 'ja-en') {
                recogSelect.value = 'ja-JP';
                transSelect.value = 'en';
            } else if (preset === 'en-zh') {
                recogSelect.value = 'en-US';
                transSelect.value = 'zh';
            }
            localStorage.setItem('selectedPreset', preset);
            checkTranslationModel(event);
            if (recognition) {
                if (isRecognizing) {
                    recognition.stop();
                    console.log('[v2] éŸ³å£°èªè­˜åœæ­¢ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´ï¼‰');
                }
                setTimeout(() => {
                    if (recognition && !isRecognizing) {
                        try {
                            recognition.lang = recogSelect.value;
                            recognition.start();
                            console.log('[v2] éŸ³å£°èªè­˜å†èµ·å‹•ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´ï¼‰');
                        } catch (error) {
                            console.error('[v2] éŸ³å£°èªè­˜å†èµ·å‹•ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´ï¼‰:', error);
                        }
                    }
                }, 1500);
            }
        });

        document.getElementById('preloadModelBtn').addEventListener('click', preloadTranslationModel);
    </script>
</body>
</html>